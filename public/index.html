<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'/>
        <script src="js/ColorUtils-min.js"></script>
    </head>
    <body>
        <!--Add a button for the user to click to initiate auth sequence -->
        <div id = "pre-authorize" style='display:none'>
        <p id ="authorize-info" style='visibility:hidden'>
        For this to work I&#8217;ll need access to your calendar&hellip;
        </p>
        <div id="authorize-button" style="visibility: hidden" tabindex="1">Authorize</div>
        </div>
        <script type="text/javascript">
            // Enter a client ID for a web application from the Google Developer Console.
            // The provided clientId will only work if the sample is run directly from
            // https://google-api-javascript-client.googlecode.com/hg/samples/authSample.html
            // In your Developer Console project, add a JavaScript origin that corresponds to the domain
            // where you will be running the script.
            var clientId = '286499572058.apps.googleusercontent.com';
            //var clientId = '286499572058-c1mqnt8uumrpl84rnnib9d127uslcri5.apps.googleusercontent.com';
            // Enter the API key from the Google Develoepr Console - to handle any unauthenticated
            // requests in the code.
            // The provided key works for this sample only when run from
            // https://google-api-javascript-client.googlecode.com/hg/samples/authSample.html
            // To use in your own application, replace this API key with your own.
            var apiKey = 'AIzaSyBS4hilOqztH7wPyrojxUspHUynG-5zQYU';

            // To enter one or more authentication scopes, refer to the documentation for the API.
            var scopes = 'https://www.googleapis.com/auth/calendar';

            // Number of the weeks in the view
            var weekRange = 12;

            // Global calendar data - TODO figure out if could be a closure var
            var locations = ["sydney", "melbourne", "brisbane", "perth"];
            var dates = [];
            var data = {};
            var calendars = [
                'thoughtworks.com_66gvl4alf8eg2iq8tg9pik00tk@group.calendar.google.com',
                'thoughtworks.com_vdmeshu1154sfkc6qocdcb6ma4@group.calendar.google.com'
            ];
            var currentCalendar = 0;

            // Use a button to handle authentication the first time.
            function handleClientLoad() {
                gapi.client.setApiKey(apiKey);
                window.setTimeout(checkAuth, 1);
            }

            function checkAuth() {
                gapi.auth.authorize({client_id:clientId, scope:scopes, immediate:true}, handleAuthResult);
            }

            function handleAuthResult(authResult) {
                var authorizeButton = document.getElementById('authorize-button');
                if (authResult) {
                    authorizeButton.style.visibility = 'hidden';
                    makeApiCall();
                    $('#pre-authorize').hide();

                } else {
                    $('#pre-authorize').show();
                    authorizeButton.style.visibility = '';
                    authorizeButton.onclick = handleAuthClick;
                }
            }

            function handleAuthClick(event) {
                gapi.auth.authorize({client_id:clientId, scope:scopes, immediate:false}, handleAuthResult);
                return false;
            }

            // Load the API and make an API call.  Display the results on the screen.
            function makeApiCall() {

                gapi.client.load('calendar', 'v3', function () {
                    buildCalendar();
                });
            }

            function buildCalendar() {

                var minDate = new Date();
                minDate.setDate(minDate.getDate() - minDate.getDay());
                var maxDate = new Date();
                maxDate.setDate((maxDate.getDate() - maxDate.getDay()) +
                    (weekRange+1)*7);

                if (currentCalendar >= calendars.length) {
                    // data is filled out - draw table
                    makeTable(locations, dates, data);
                    return;
                }
                    
                // still more data to fetch for the currentCalendar
                var request = gapi.client.calendar.events.list({
                    'calendarId': calendars[currentCalendar],
                    'singleEvents':true,
                    'timeMin':ISODateString(minDate),
                    'timeMax':ISODateString(maxDate)
                });

                request.execute(function (resp) {

                    var currentWeek = new Date().getWeek();

                    for (var i = 0; i < resp.items.length; i++) {
                        var calendarEntry = resp.items[i];
                        var locationAndPerson = getCalendarLocationAndPerson(calendarEntry);
                        if (!locationAndPerson) continue;
                        var location = locationAndPerson[0];
                        // TODO For now skipping the half-day calendar entries -
                        // where dateTime is used instead of date.
                        if (!calendarEntry.start.date) continue;
                        var date = Date.fromGapiDateString(calendarEntry.start.date);
                        if (date.getWeek() - currentWeek < weekRange)
                        {
                            if (locations.indexOf(location) == -1)  {
                                locations.push(location);
                            }
                        }
                    }

                    for (var i = 0; i < locations.length; i++)
                    {
                        var location = locations[i];
                        if (!data[location]) {
                            data[location] = {}
                        }
                        for(var j = 0; j < weekRange; j++)
                        {
                            var date = new Date();
                            date.setDate(date.getDate() - date.getDay() + (7 * j));

                            var dateFormat = date.toString("dd-MMMM");
                            dates[j] = dateFormat;
                            if (!data[location][dateFormat]) {
                                data[location][dateFormat] = [];
                            }
                        }
                    }

                    for (var i = 0; i < resp.items.length; i++) {
                        var calendarEntry = resp.items[i];
                        var locationAndPerson = getCalendarLocationAndPerson(calendarEntry);
                        if (!locationAndPerson) continue;
                        var location = locationAndPerson[0];
                        var person = locationAndPerson[1];
                        if (!calendarEntry.start.date) continue;
                        var date = Date.fromGapiDateString(calendarEntry.start.date);
                        date.setDate(date.getDate() - date.getDay());

                        if(dates.indexOf(dateFormat) == -1)
                        {
                            date = Date.fromGapiDateString(calendarEntry.end.date);
                            date.setDate(date.getDate() - date.getDay());
                        }

                        var dateFormat = date.toString("dd-MMMM");
                        var weekDiff = date.getWeek() - currentWeek;

                        if(weekDiff < weekRange && dates.indexOf(dateFormat) != -1)
                        {
                            if(data[location][dateFormat].indexOf(person) == -1)
                                data[location][dateFormat].push(
                                    {person:person, link:calendarEntry.htmlLink});
                        }
                    }
                    
                    buildCalendar(++currentCalendar);
                });
            }

            function makeTable(location, dates, data) {
                var rows = new Array();
                var cells = new Array();

                var row_num = location.length; //edit this value to suit
                var cell_num = dates.length;

                var tab = document.createElement('table');
                tab.setAttribute('id', 'calendar');

                var tbo = document.createElement('tbody');

                for (var row = 0; row < row_num + 1; row++) {
                    rows[row] = document.createElement('tr');

                    for (var col = 0; col < cell_num + 1; col++) {
                        if(row == 0 && col == 0)
                        {
                            $(rows[row]).append("<th></th>");
                        }
                        else if(row == 0)
                        {
                            $(rows[row]).append("<th>" + dates[col - 1] + "</th>");
                        }
                        else if(col == 0)
                        {
                            $(rows[row]).append("<td class='leftHeading'>" + location[row - 1] + "</td>");
                        }
                        else
                        {
                            var entries = data[location[row - 1]][dates[col - 1]];
                            var text = "";

                            for(var i = 0; i < entries.length; i++)
                            {
                                var p = entries[i].person;
                                var l = entries[i].link;
                                text += "<div class='person " + p + "'>"
                                        + "<a href='" + l + "'>" 
                                        + p + "</a></div>";
                            }
                            $(rows[row]).append("<td>" + text + "</td>");
                        }
                    }
                    tbo.appendChild(rows[row]);
                }
                tab.appendChild(tbo);
                document.getElementById('tableHolder').appendChild(tab);
                colorize();
            }

            function ISODateString(d) {
                function pad(n) {
                    return n < 10 ? '0' + n : n
                }

                return d.getUTCFullYear() + '-'
                        + pad(d.getUTCMonth() + 1) + '-'
                        + pad(d.getUTCDate()) + 'T'
                        + pad(d.getUTCHours()) + ':'
                        + pad(d.getUTCMinutes()) + ':'
                        + pad(d.getUTCSeconds()) + 'Z'
            }

            Date.prototype.getWeek = function() {
                var onejan = new Date(this.getFullYear(),0,1);
                return Math.ceil((((this - onejan) / 86400000) + onejan.getDay()+1)/7);
            }

            // Safari does not support date format returned by
            // gapi calendar events yyyy-mm-dd hence the manual parsing below
            Date.fromGapiDateString = function(gapiDateString) {
                var dateParts = gapiDateString.split("-");
                var date = new Date(dateParts[0], dateParts[1]-1, dateParts[2]);
                return date;
            }

            Array.prototype.uniq = function(){
              var u = {}, a = [];
              for(var i = 0, l = this.length; i < l; ++i){
                if(this[i] in u) {
                  continue;
                }
                a.push(this[i]);
                u[this[i]] = 1;
              }
              return a;
            }

            function colorize() {
                var names = $('.person').map(function() { return jQuery.trim(this.className.replace('person', '')); }).get().uniq();
                var start =  new Hex('93FFB4');  
                var rainbow = start.equal(names.length, true);
                names.forEach(function(name, index) {
                  console.log(rainbow[index]);
                  $('.' + name).css({background: '#' + rainbow[index].hex});
                });                    
            }

            //
            // Extracts calendar entries person and location from its summary
            // This is relying on the patterns of entries seen in tw calendards
            // so far - new patters may be discovered.
            // Returns a list [location, person]
            //
            function getCalendarLocationAndPerson(calendarEntry) {
                var locationAndPerson = calendarEntry.summary.split(/\s([oi]n|@|at)\s/);
                if (locationAndPerson 
                        && locationAndPerson.length >= 3) {
                    
                    var location = locationAndPerson[2].split(" ")[0].toLowerCase();
                    if (isLocation(location)) {
                        return  [
                                    location,
                                    locationAndPerson[0] 
                                ];
                    }
                }
                return undefined;
            }

            // Since people use calendar entries to indicate on leave, at uni,
            // Mgmnt, etc. we are filtering them out as locations. More to be
            // found. Location is converted in lower-case already before being
            // passed here.
            function isLocation(location) {
                return (['uni', 'mgmt', 'leave'].indexOf(location) == -1);
            }
        
        </script>
        <script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
        <script src="js/date.js"></script>
        <script src="js/jquery-1.7.2.min.js"></script>
        <link rel="stylesheet" href="css/main.css">

        <div id="content"></div>
        <div id="events"></div>
        <div id="tableHolder"></div>
    </body>
</html>
